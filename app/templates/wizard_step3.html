{% extends "wizard_base.html" %}

{% block wizard_content %}
<h1>Déposer une annonce - Étape 3/5</h1>
<p class="subtitle">Ajoutez des photos de votre équipement (maximum 3)</p>

<form method="post" action="/deposer/step3" enctype="multipart/form-data" id="photo-form">
  <input type="hidden" name="listing_id" value="{{ draft.id }}" />
  
  <div class="form-group">
    <label for="photos">Photos de l'équipement *</label>
    <input 
      type="file" 
      id="photos" 
      name="photos" 
      accept="image/jpeg,image/jpg,image/png,image/webp,image/gif"
      multiple 
      required
      data-max-files="3" />
    <small>Sélectionnez jusqu'à 3 photos (formats acceptés : JPG, PNG, WEBP, GIF)</small>
    <div id="file-error" style="color: var(--danger-color); margin-top: 8px; display: none;"></div>
  </div>

  {% if draft and draft.photos and draft.photos|length > 0 %}
  <div class="current-photos" style="margin-top: 20px;">
    <h3 style="font-size: 16px; margin-bottom: 12px;">Photos actuelles :</h3>
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
      {% for photo in draft.photos %}
      <div style="position: relative; width: 120px; height: 120px;">
        <img src="{{ photo.url }}" alt="Photo {{ loop.index }}" 
             style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius); border: 2px solid var(--border-color);" />
        <span style="position: absolute; top: 4px; right: 4px; background: var(--primary-color); color: white; 
                     padding: 2px 6px; border-radius: 3px; font-size: 12px;">{{ loop.index }}</span>
      </div>
      {% endfor %}
    </div>
    <small style="display: block; margin-top: 8px; color: var(--text-gray);">
      Pour modifier vos photos, sélectionnez de nouvelles images ci-dessus (les anciennes seront remplacées).
    </small>
  </div>
  {% endif %}

  <div style="margin-top: 20px; padding: 20px; background: var(--bg-light); border-radius: var(--radius); border-left: 4px solid var(--primary-color);">
    <p style="font-size: 14px; color: var(--text-gray); line-height: 1.6; margin: 0;">
      <strong>Important :</strong> Vous devez télécharger entre 1 et 3 photos de votre équipement depuis votre ordinateur. 
      Les photos sont stockées de manière sécurisée sur Supabase Storage.
    </p>
  </div>

  <div style="margin-top: 32px; display: flex; gap: 16px; justify-content: space-between;">
    <a href="/deposer/step2?listing_id={{ draft.id }}" class="btn-secondary">← Retour</a>
    <button type="submit" class="btn-primary" id="submit-btn">Suivant →</button>
  </div>
</form>

<script>
// Client-side validation for max 3 photos
document.getElementById('photo-form').addEventListener('submit', function(e) {
  const fileInput = document.getElementById('photos');
  const errorDiv = document.getElementById('file-error');
  const submitBtn = document.getElementById('submit-btn');
  
  if (fileInput.files.length > 3) {
    e.preventDefault();
    errorDiv.textContent = 'Vous ne pouvez sélectionner que 3 photos maximum.';
    errorDiv.style.display = 'block';
    return false;
  }
  
  if (fileInput.files.length === 0) {
    e.preventDefault();
    errorDiv.textContent = 'Veuillez sélectionner au moins une photo.';
    errorDiv.style.display = 'block';
    return false;
  }
  
  // Validate file types
  const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
  for (let i = 0; i < fileInput.files.length; i++) {
    if (!validTypes.includes(fileInput.files[i].type)) {
      e.preventDefault();
      errorDiv.textContent = 'Format de fichier invalide. Utilisez JPG, PNG, WEBP ou GIF uniquement.';
      errorDiv.style.display = 'block';
      return false;
    }
  }
  
  // Show loading state
  submitBtn.disabled = true;
  submitBtn.textContent = 'Téléchargement en cours...';
  
  errorDiv.style.display = 'none';
  return true;
});

// Show file count on selection
document.getElementById('photos').addEventListener('change', function(e) {
  const errorDiv = document.getElementById('file-error');
  const count = e.target.files.length;
  
  if (count > 3) {
    errorDiv.textContent = `Vous avez sélectionné ${count} photos. Maximum : 3. Veuillez en retirer ${count - 3}.`;
    errorDiv.style.display = 'block';
  } else if (count > 0) {
    errorDiv.textContent = `${count} photo${count > 1 ? 's' : ''} sélectionnée${count > 1 ? 's' : ''}.`;
    errorDiv.style.color = 'var(--success-color)';
    errorDiv.style.display = 'block';
  } else {
    errorDiv.style.display = 'none';
  }
});
</script>
{% endblock %}
