{% extends "wizard_base.html" %}

{% block wizard_content %}
<h1>Déposer une annonce - Étape 3/5</h1>
<p class="subtitle">Ajoutez une photo de votre équipement</p>

<form method="post" action="/deposer/step3" enctype="multipart/form-data" id="photo-form">
  <input type="hidden" name="listing_id" value="{{ draft.id }}" />
  
  <div class="form-group">
    <label for="photos">Photo de l'équipement *</label>
    <input 
      type="file" 
      id="photos" 
      name="photos" 
      accept="image/jpeg,image/jpg,image/png,image/webp,image/gif"
      required />
    <small>Sélectionnez 1 photo (formats acceptés : JPG, PNG, WEBP, GIF)</small>
    <div id="file-error" style="color: var(--danger-color); margin-top: 8px; display: none;"></div>
  </div>

  {% if draft and draft.photos and draft.photos|length > 0 %}
  <div class="current-photos" style="margin-top: 20px;">
    <h3 style="font-size: 16px; margin-bottom: 12px;">Photo actuelle :</h3>
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
      <div style="position: relative; width: 120px; height: 120px;">
        <img src="{{ draft.photos[0].url }}" alt="Photo" 
             style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius); border: 2px solid var(--border-color);" />
      </div>
    </div>
    <small style="display: block; margin-top: 8px; color: var(--text-gray);">
      Pour modifier votre photo, sélectionnez une nouvelle image ci-dessus (l'ancienne sera remplacée).
    </small>
  </div>
  {% endif %}

  <div style="margin-top: 20px; padding: 20px; background: var(--bg-light); border-radius: var(--radius); border-left: 4px solid var(--primary-color);">
    <p style="font-size: 14px; color: var(--text-gray); line-height: 1.6; margin: 0;">
      <strong>Important :</strong> Vous devez télécharger 1 photo de votre équipement depuis votre ordinateur. 
      La photo est stockée de manière sécurisée sur Supabase Storage.
    </p>
  </div>

  <div style="margin-top: 32px; display: flex; gap: 16px; justify-content: space-between;">
    <a href="/deposer/step2?listing_id={{ draft.id }}" class="btn-secondary">← Retour</a>
    <button type="submit" class="btn-primary" id="submit-btn">Suivant →</button>
  </div>
</form>

<script>
// Client-side validation for 1 photo only
document.getElementById('photo-form').addEventListener('submit', function(e) {
  const fileInput = document.getElementById('photos');
  const errorDiv = document.getElementById('file-error');
  const submitBtn = document.getElementById('submit-btn');
  
  // Reset color to danger
  errorDiv.style.color = 'var(--danger-color)';
  
  if (fileInput.files.length > 1) {
    e.preventDefault();
    errorDiv.textContent = 'Vous ne pouvez sélectionner qu\'1 photo uniquement.';
    errorDiv.style.display = 'block';
    return false;
  }
  
  if (fileInput.files.length === 0) {
    e.preventDefault();
    errorDiv.textContent = 'Veuillez sélectionner une photo.';
    errorDiv.style.display = 'block';
    return false;
  }
  
  // Validate file type
  const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
  if (!validTypes.includes(fileInput.files[0].type)) {
    e.preventDefault();
    errorDiv.textContent = 'Format de fichier invalide. Utilisez JPG, PNG, WEBP ou GIF uniquement.';
    errorDiv.style.display = 'block';
    return false;
  }
  
  // Show loading state
  submitBtn.disabled = true;
  submitBtn.textContent = 'Téléchargement en cours...';
  
  errorDiv.style.display = 'none';
  return true;
});

// Show file selection status
document.getElementById('photos').addEventListener('change', function(e) {
  const errorDiv = document.getElementById('file-error');
  const count = e.target.files.length;
  
  if (count > 1) {
    errorDiv.style.color = 'var(--danger-color)';
    errorDiv.textContent = `Vous avez sélectionné ${count} photos. Vous ne pouvez sélectionner qu'1 photo.`;
    errorDiv.style.display = 'block';
  } else if (count === 1) {
    errorDiv.style.color = 'var(--success-color)';
    errorDiv.textContent = '1 photo sélectionnée.';
    errorDiv.style.display = 'block';
  } else {
    errorDiv.style.display = 'none';
  }
});
</script>
{% endblock %}
